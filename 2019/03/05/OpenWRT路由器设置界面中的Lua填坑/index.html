<!DOCTYPE html>
<html class="theme-next mist use-motion" lang="zh-CN">

<head>
    <meta name="generator" content="Hexo 3.8.0">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="theme-color" content="#222">
    <link rel="stylesheet" media="all" href="/lib/Han/dist/han.min.css?v=3.3">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta name="msvalidate.01" content="8179465A3D0D22CB057CCA1F67C92680">
    <link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">
    <link href="/css/main.css?v=6.6.0" rel="stylesheet" type="text/css">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/panda-32x32.png?v=6.6.0">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/panda-16x16.png?v=6.6.0">
    <script type="text/javascript" id="hexo.configurations">
        var NexT = window.NexT || {};
        var CONFIG = {
            root: '/',
            scheme: 'Mist',
            version: '6.6.0',
            sidebar: {
                "position": "left",
                "display": "post",
                "offset": 12,
                "b2t": false,
                "scrollpercent": false,
                "onmobile": false
            },
            fancybox: false,
            fastclick: false,
            lazyload: false,
            tabs: true,
            motion: {
                "enable": true,
                "async": false,
                "transition": {
                    "post_block": "fadeIn",
                    "post_header": "slideDownIn",
                    "post_body": "slideDownIn",
                    "coll_header": "slideLeftIn",
                    "sidebar": "slideUpIn"
                }
            },
            algolia: {
                applicationID: '',
                apiKey: '',
                indexName: '',
                hits: {
                    "per_page": 10
                },
                labels: {
                    "input_placeholder": "Search for Posts",
                    "hits_empty": "We didn't find any results for the search: ${query}",
                    "hits_stats": "${hits} results found in ${time} ms"
                }
            }
        };
    </script>
    <meta name="description" content="刚结束一个急活，主要是整理某个 OpenWRT 路由的设置界面，网页服务主要用的是 Nginx，网页用的是 BackBone 和 jQuery 配合，后端设置服务主要用的是 Lua（由 Nginx 代理）调用 OpenWRT 的 UCI 和 ubus。一开始我以为只需要前端稍微调整下就行了，后来发现后边跟着的 Lua 得一起整，顺带补了不少 OpenWRT 的基础知识，下边简单梳(还)理(债)……">
    <meta name="keywords" content="随手记,OpenWRT">
    <meta property="og:type" content="article">
    <meta property="og:title" content="OpenWRT路由器设置界面中的Lua填坑">
    <meta property="og:url" content="https://marsgt.github.io/2019/03/05/OpenWRT路由器设置界面中的Lua填坑/index.html">
    <meta property="og:site_name" content="某熊猫桑·自留地">
    <meta property="og:description" content="刚结束一个急活，主要是整理某个 OpenWRT 路由的设置界面，网页服务主要用的是 Nginx，网页用的是 BackBone 和 jQuery 配合，后端设置服务主要用的是 Lua（由 Nginx 代理）调用 OpenWRT 的 UCI 和 ubus。一开始我以为只需要前端稍微调整下就行了，后来发现后边跟着的 Lua 得一起整，顺带补了不少 OpenWRT 的基础知识，下边简单梳(还)理(债)……">
    <meta property="og:locale" content="zh-CN">
    <meta property="og:updated_time" content="2019-03-08T00:54:45.671Z">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="OpenWRT路由器设置界面中的Lua填坑">
    <meta name="twitter:description" content="刚结束一个急活，主要是整理某个 OpenWRT 路由的设置界面，网页服务主要用的是 Nginx，网页用的是 BackBone 和 jQuery 配合，后端设置服务主要用的是 Lua（由 Nginx 代理）调用 OpenWRT 的 UCI 和 ubus。一开始我以为只需要前端稍微调整下就行了，后来发现后边跟着的 Lua 得一起整，顺带补了不少 OpenWRT 的基础知识，下边简单梳(还)理(债)……">
    <link rel="alternate" href="/atom.xml" title="某熊猫桑·自留地" type="application/atom+xml">
    <link rel="canonical" href="https://marsgt.github.io/2019/03/05/OpenWRT路由器设置界面中的Lua填坑/">
    <script type="text/javascript" id="page.configurations">
        CONFIG.page = {
            sidebar: "",
        };
    </script>
    <title>OpenWRT路由器设置界面中的Lua填坑 | 某熊猫桑·自留地</title>
    <noscript>
        <style>
            .use-motion .motion-element,
            .use-motion .brand,
            .use-motion .menu-item,
            .sidebar-inner,
            .use-motion .post-block,
            .use-motion .pagination,
            .use-motion .comments,
            .use-motion .post-header,
            .use-motion .post-body,
            .use-motion .collection-title {
                opacity: initial;
            }

            .use-motion .logo,
            .use-motion .site-title,
            .use-motion .site-subtitle {
                opacity: initial;
                top: initial;
            }

            .use-motion .logo-line-before i {
                left: initial;
            }

            .use-motion .logo-line-after i {
                right: initial;
            }
        </style>
    </noscript>
<link rel="stylesheet" href="/css/prism-xonokai.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
    <div class="container sidebar-position-left page-post-detail">
        <div class="headband"></div>
        <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
            <div class="header-inner">
                <div class="site-brand-wrapper">
                    <div class="site-meta ">
                        <div class="custom-logo-site-title">
                            <a href="/" class="brand" rel="start">
                                <span class="logo-line-before"><i></i></span>
                                <span class="site-title">某熊猫桑·自留地</span>
                                <span class="logo-line-after"><i></i></span>
                            </a>
                        </div>
                    </div>
                    <div class="site-nav-toggle">
                        <button aria-label="切换导航栏">
                            <span class="btn-bar"></span>
                            <span class="btn-bar"></span>
                            <span class="btn-bar"></span>
                        </button>
                    </div>
                </div>
                <nav class="site-nav">
                    <ul id="menu" class="menu">
                        <li class="menu-item menu-item-home">
                            <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>
                        </li>
                        <li class="menu-item menu-item-tags">
                            <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>
                        </li>
                        <li class="menu-item menu-item-categories">
                            <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-cube"></i> <br>分类</a>
                        </li>
                        <li class="menu-item menu-item-navigation">
                            <a href="/nav/" rel="section"><i class="menu-item-icon fa fa-fw fa-magic"></i> <br>导航</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </header>
        <main id="main" class="main">
            <div class="main-inner">
                <div class="content-wrap">
                    <div id="content" class="content">
                        <div id="posts" class="posts-expand">
                            <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
                                <div class="post-block">
                                    <link itemprop="mainEntityOfPage" href="https://marsgt.github.io/2019/03/05/OpenWRT路由器设置界面中的Lua填坑/">
                                    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                                        <meta itemprop="name" content="某熊猫桑">
                                        <meta itemprop="description" content>
                                        <meta itemprop="image" content="/images/avatar.jpg">
                                    </span>
                                    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                                        <meta itemprop="name" content="某熊猫桑·自留地">
                                    </span>
                                    <header class="post-header">
                                        <h2 class="post-title" itemprop="name headline">OpenWRT路由器设置界面中的Lua填坑 </h2>
                                        <div class="post-meta">
                                            <span class="post-time">
                                                <span class="post-meta-item-icon">
                                                    <i class="fa fa-calendar-o"></i>
                                                </span>
                                                <span class="post-meta-item-text">发表于</span>
                                                <time title="创建时间：2019-03-05 10:18:50" itemprop="dateCreated datePublished" datetime="2019-03-05T10:18:50+08:00">2019-03-05</time>
                                            </span>
                                            <span class="post-category">
                                                <span class="post-meta-divider">|</span>
                                                <span class="post-meta-item-icon">
                                                    <i class="fa fa-folder-o"></i>
                                                </span>
                                                <span class="post-meta-item-text">分类于</span>
                                                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/经验技巧/" itemprop="url" rel="index"><span itemprop="name">经验技巧</span></a></span>
                                            </span>
                                        </div>
                                    </header>
                                    <div class="post-body han-init-context" itemprop="articleBody">
                                        <p>刚结束一个急活，主要是整理某个 OpenWRT 路由的设置界面，网页服务主要用的是 Nginx，网页用的是 BackBone 和 jQuery 配合，后端设置服务主要用的是 Lua（由 Nginx 代理）调用 OpenWRT 的 UCI 和 ubus。一开始我以为只需要前端稍微调整下就行了，后来发现后边跟着的 Lua 得一起整，顺带补了不少 OpenWRT 的基础知识，下边简单梳(还)理(债)…… <a id="more"></a>
                                        </p>
                                        <h2 id="UCI"><a href="#UCI" class="headerlink" title="UCI"></a>UCI</h2>
                                        <h3 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h3>
                                        <p>UCI 是“Unified Configuration Interface”（统一配置界面）的缩写，是 OpenWrt 系统的核心配置框架，它的主要作用是整合系统里不同的设置项，并提供一个统一的接口。OpenWrt 系统配置文件默认被集中放在了 <code>/etc/config</code> 这里（当然也可以放在其它地方），这些 UCI 文件有自己特殊的语法，比如一个典型的无线配置可能是：</p>
                                        <pre><code>config wifi-device &#39;radio0&#39;
    option type &#39;mac80211&#39;
    option channel &#39;auto&#39;
    option hwmode &#39;11g&#39;
    option path &#39;platform/qca953x_wmac&#39;
    option htmode &#39;HT20&#39;
    option disabled &#39;0&#39;

config wifi-iface
    option ifname &#39;wlan0&#39;
    option device &#39;radio0&#39;
    option network &#39;lan&#39;
    option mode &#39;ap&#39;
    option encryption &#39;none&#39;
    option ssid &#39;TestSSID&#39;
</code></pre>
                                        <p>这里以 config 开头的行代表了一个 config 节点，其格式为：<br><code>config &#39;section-type&#39; &#39;section&#39;</code><br>section-type 处的值是节点类型，而 section 则是节点名称。另外，config 节点允许匿名节点的存在（意即直接跳过<code>&#39;section&#39;</code>，就像第二个的 config 节点那样，<code>wifi-iface</code>只是节点类型而不是节点名，这里要注意），引号在 UCI 文件中也不是必须的，严格来讲只有值里带有空格或制表符时才需要使用，使用时也要注意，其必须成对出现才有效（比如一对单引号或者一对双引号，交叉使用会导致语法错误）。<br>以 option 开头的是选项，格式为：<br><code>option &#39;key&#39; &#39;value&#39;</code><br>这是比较典型的 key-value 格式，就不再赘述了。除此之外，还有种 list 列表选项，被用来描述形如数组类的设置，格式与 option 非常相似：<br><code>list &#39;list-key&#39; &#39;list-value&#39;</code><br>如果 list-key 相同的话，那么这实际上就是个数组式的设置项，举个栗子，system 设置里的 NTP：</p>
                                        <pre><code>config timeserver &#39;ntp&#39;
    option enabled &#39;1&#39;
    option enable_server &#39;0&#39;
    list server &#39;0.openwrt.pool.ntp.org&#39;
    list server &#39;1.openwrt.pool.ntp.org&#39;
    list server &#39;2.openwrt.pool.ntp.org&#39;
    list server &#39;3.openwrt.pool.ntp.org&#39;
</code></pre>
                                        <p>这里的 NTP Server 设置实际上就是个数组。</p>
                                        <h3 id="UCI-的调用"><a href="#UCI-的调用" class="headerlink" title="UCI 的调用"></a>UCI 的调用</h3>
                                        <p>在 OpenWRT 系统里调用 UCI 一般有两种方法，通过命令行或者是调用 Lua API。这里首先说命令行。<br>OpenWRT 官方文档里提到，使用awk、grep等命令来解析Openwrt的配置文件是低效和不明智的做法，并建议在类似的场景下，应该优先使用命令行形式调用。<br>UCI 命令行语法为（在命令行下直接输入 <code>uci</code> 即可看到）：</p>
                                        <pre><code>用法: uci [&lt;options&gt;] &lt;command&gt; [&lt;arguments&gt;]

命令:
    batch
    export     [&lt;config&gt;]
    import     [&lt;config&gt;]
    changes    [&lt;config&gt;]
    commit     [&lt;config&gt;]
    add        &lt;config&gt; &lt;section-type&gt;
    add_list   &lt;config&gt;.&lt;section&gt;.&lt;option&gt;=&lt;string&gt;
    show       [&lt;config&gt;[.&lt;section&gt;[.&lt;option&gt;]]]
    get        &lt;config&gt;.&lt;section&gt;[.&lt;option&gt;]
    set        &lt;config&gt;.&lt;section&gt;[.&lt;option&gt;]=&lt;value&gt;
    delete     &lt;config&gt;[.&lt;section[.&lt;option&gt;]]
    rename     &lt;config&gt;.&lt;section&gt;[.&lt;option&gt;]=&lt;name&gt;
    revert     &lt;config&gt;[.&lt;section&gt;[.&lt;option&gt;]]

参数:
    -c &lt;path&gt;  设置用于存储配置文件的文件夹 (默认位于: /etc/config)
    -d &lt;str&gt;   使用&#39;uci show&#39;命令时，为 list 类型的值设置分隔符
    -f &lt;file&gt;  使用指定的 &lt;file&gt; 作为输入，而不是默认的 stdin
    -m         导入时，合并数据到现有的设置中
    -n         导出时，命名匿名节 (默认)
    -N         不要命名匿名节
    -p &lt;path&gt;  添加一个配置文件的搜索路径
    -P &lt;path&gt;  添加一个配置文件的搜索路径并将其作为默认设置
    -q         安静默认 (不打印错误信息)
    -s         强制使用严格模式 (在解析出现错误时停止，默认)
    -S         关闭严格模式
    -X         在&#39;show&#39;命令上显示匿名节点ID (如果有的话)
</code></pre>
                                        <p>平时（命令行下）常用的主要是 <code>show</code>，<code>get</code>，<code>set</code>，<code>changes</code> 和 <code>commit</code> 这几个。<br>使用 UCI 时，需要特别注意下它的读写规则：UCI 在读取时，会首先读取内存中的缓存，而后才是文件；而写入则与此相反，增删改都是在操作缓存，需要手动提交才会将设置项写入到系统中。所以，在编写路由设置系统时，最后的提交操作是切不可忘的一步。<br>还有一种调用 UCI 的方法，是使用 Lua，文末的参考内容[3]中有详细的 API 列表（记得在开头用 <code>local uci = require &quot;los.uci&quot;.cursor()</code> 语句引入）。<br>在使用 Lua 调用时，有个需要注意的点是匿名节点，比如上文中的无线配置里，有个 <code>wifi-iface</code> 类型的匿名节点，在命令行里使用 <code>uci show wireless</code> 可以看到：</p>
                                        <pre><code>wireless.radio1=wifi-device
wireless.radio1.type=&#39;mac80211&#39;
wireless.radio1.channel=&#39;auto&#39;
wireless.radio1.hwmode=&#39;11g&#39;
wireless.radio1.path=&#39;platform/qca953x_wmac&#39;
wireless.radio1.htmode=&#39;HT20&#39;
wireless.radio1.disabled=&#39;0&#39;
wireless.@wifi-iface[0]=wifi-iface
wireless.@wifi-iface[0].ifname=&#39;wlan0&#39;
wireless.@wifi-iface[0].device=&#39;mt7620&#39;
wireless.@wifi-iface[0].network=&#39;lan&#39;
wireless.@wifi-iface[0].mode=&#39;ap&#39;
wireless.@wifi-iface[0].encryption=&#39;none&#39;
wireless.@wifi-iface[0].ssid=&#39;TestSSID&#39;
</code></pre>
                                        <p>这里可以看到很多键名类似 <code>@wifi-iface[0]</code> 的设置项，这就是匿名节点的设置项了。如果在命令行里加入 <code>-X</code> 参数变成 <code>uci -X show wireless</code>，则可以看到：</p>
                                        <pre><code>wireless.radio1=wifi-device
wireless.radio1.type=&#39;mac80211&#39;
wireless.radio1.channel=&#39;auto&#39;
wireless.radio1.hwmode=&#39;11g&#39;
wireless.radio1.path=&#39;platform/qca953x_wmac&#39;
wireless.radio1.htmode=&#39;HT20&#39;
wireless.radio1.disabled=&#39;0&#39;
wireless.cfg043579=wifi-iface
wireless.cfg043579.ifname=&#39;wlan1&#39;
wireless.cfg043579.device=&#39;radio1&#39;
wireless.cfg043579.network=&#39;lan&#39;
wireless.cfg043579.mode=&#39;ap&#39;
wireless.cfg043579.encryption=&#39;none&#39;
wireless.cfg043579.ssid=&#39;TestSSID&#39;
</code></pre>
                                        <p>这时 <code>@wifi-iface[0]</code> 变成了 <code>cfg043579</code>，这才是这个匿名节点真实的引用名（系统自动生成的）。<br>而同样的，在撰写相对应的 Lua 语句时，也不能写成：</p>
                                        <pre class=" language-lua"><code class="language-lua">uci<span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"wireless"</span><span class="token punctuation">,</span> <span class="token string">"@wifi-iface[0]"</span><span class="token punctuation">,</span> <span class="token string">"ssid"</span><span class="token punctuation">,</span> <span class="token string">"NewSSID"</span><span class="token punctuation">)</span>
</code></pre>
                                        <p>虽然可以在命令行执行 <code>uci set wireless.@wifi-iface[0].ssid=&#39;NewSSID&#39;</code>，但是在 Lua 上这么写系统是不会鸟你的（更何况还有个隐性的问题，是设置被改动过后，匿名节点的位置有可能会变，比如会跑到 <code>@wifi-iface[1]</code> 去，这可能会发生在拥有多个匿名节点的配置文件里）。所以这个时候，就需要使用 <code>uci:foreach</code> 去遍历某个设置类型的所有设置节点（注：返回 false 终止遍历），在遍历出的内容里，有几个特殊的、键名以英文字符 <code>.</code> 开头的成员：</p>
                                        <ul>
                                            <li><code>[.index]</code>: 设置节点的索引</li>
                                            <li><code>[.name]</code>: 设置节点的名称（即真实的引用名，<code>cfg043579</code> 这种）</li>
                                            <li><code>[.type]</code>: 设置节点的类型（如 <code>wifi-iface</code>）</li>
                                            <li><code>[.anonymous]</code>: 指示该设置节点是否匿名</li>
                                        </ul>
                                        <p>这样，通过遍历所有项目并筛选符合条件的配置项，将 <code>[.name]</code> 中的内容缓存下来，就可以用：</p>
                                        <pre class=" language-lua"><code class="language-lua">uci<span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"wireless"</span><span class="token punctuation">,</span> <span class="token string">"cfg043579"</span><span class="token punctuation">,</span> <span class="token string">"ssid"</span><span class="token punctuation">,</span> <span class="token string">"NewSSID"</span><span class="token punctuation">)</span>
</code></pre>
                                        <p>这种方法去调用了。<br>这里放个自己写的用于遍历无线设置的函数（双频设备，每个频段只有一个信号，通过设备 ID 来识别）：</p>
                                        <pre class=" language-lua"><code class="language-lua"><span class="token keyword">function</span> <span class="token function">getWirelessInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span> wifiConfig <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    uci<span class="token punctuation">:</span><span class="token function">foreach</span><span class="token punctuation">(</span>
        <span class="token string">"wireless"</span><span class="token punctuation">,</span>
        <span class="token string">"wifi-iface"</span><span class="token punctuation">,</span>
        <span class="token keyword">function</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
            <span class="token keyword">if</span> s<span class="token punctuation">.</span>device <span class="token operator">==</span> <span class="token string">"mt7620"</span> <span class="token keyword">then</span>
                <span class="token keyword">if</span> <span class="token keyword">not</span> wifiConfig<span class="token punctuation">.</span>mt7620 <span class="token keyword">then</span>
                    wifiConfig<span class="token punctuation">[</span><span class="token string">"mt7620"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
                <span class="token keyword">end</span>
                <span class="token keyword">local</span> key <span class="token operator">=</span> <span class="token string">""</span>
                <span class="token keyword">if</span> s<span class="token punctuation">.</span>key <span class="token keyword">then</span>
                    key <span class="token operator">=</span> s<span class="token punctuation">.</span>key
                <span class="token keyword">end</span>
                wifiConfig<span class="token punctuation">.</span>mt7620 <span class="token operator">=</span> <span class="token punctuation">{</span>
                    name <span class="token operator">=</span> s<span class="token punctuation">[</span><span class="token string">".name"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    ssid <span class="token operator">=</span> s<span class="token punctuation">.</span>ssid<span class="token punctuation">,</span>
                    ency <span class="token operator">=</span> s<span class="token punctuation">.</span>encryption<span class="token punctuation">,</span>
                    pass <span class="token operator">=</span> key
                <span class="token punctuation">}</span>
            <span class="token keyword">elseif</span> s<span class="token punctuation">.</span>device <span class="token operator">==</span> <span class="token string">"mt7612"</span> <span class="token keyword">then</span>
                <span class="token keyword">if</span> <span class="token keyword">not</span> wifiConfig<span class="token punctuation">.</span>mt7612 <span class="token keyword">then</span>
                    wifiConfig<span class="token punctuation">[</span><span class="token string">"mt7612"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
                <span class="token keyword">end</span>
                <span class="token keyword">local</span> key <span class="token operator">=</span> <span class="token string">""</span>
                <span class="token keyword">if</span> s<span class="token punctuation">.</span>key <span class="token keyword">then</span>
                    key <span class="token operator">=</span> s<span class="token punctuation">.</span>key
                <span class="token keyword">end</span>
                wifiConfig<span class="token punctuation">.</span>mt7612 <span class="token operator">=</span> <span class="token punctuation">{</span>
                    name <span class="token operator">=</span> s<span class="token punctuation">[</span><span class="token string">".name"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    ssid <span class="token operator">=</span> s<span class="token punctuation">.</span>ssid<span class="token punctuation">,</span>
                    ency <span class="token operator">=</span> s<span class="token punctuation">.</span>encryption<span class="token punctuation">,</span>
                    pass <span class="token operator">=</span> key
                <span class="token punctuation">}</span>
            <span class="token keyword">end</span>
        <span class="token keyword">end</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">return</span> wifiConfig
<span class="token keyword">end</span>
</code></pre>
                                        <p>不过，在实践中，我认为最有效的手段是将匿名节点转化成普通的具名节点，这样 Lua 就可以直接调用，比写挨个遍历内容的逻辑要简单也清晰的多。</p>
                                        <p>下边再说说 ubus。</p>
                                        <h2 id="ubus"><a href="#ubus" class="headerlink" title="ubus"></a>ubus</h2>
                                        <p>ubus 即是 OpenWrt micro bus 架构，是 OpenWrt 为了提供守护进程和应用程序间的通讯而开发的项目。简单来说，想获取系统运行的一些状态，是可以用 ubus 来查看的，而且相比用 UCI 查询，由于 ubus 获取的直接是系统信息而不是设置项，所以可以避免由于错误配置带来的配置项与系统状态不符合的问题。也是因为这个原因，我推荐读取设置(状态)时用 ubus，写入设置时用 UCI。<br>当然 ubus 也并不是没有问题，目前比较通用的说法是，在数据内容超过 60k 时不建议用，另外如果有多线程、或者逻辑上有递归时也不建议用（指令发出以后，接受到的信息可能是另一条指令的返回内容）。</p>
                                        <h3 id="ubus-的调用"><a href="#ubus-的调用" class="headerlink" title="ubus 的调用"></a>ubus 的调用</h3>
                                        <p>同 UCI 类似，调用 ubus 也分为命令行方式与 Lua 调用方式。而与 UCI 将设置文件命名为包（package）不同的是，ubus 将其调度单位称为“命名空间”（namespace），系统后台会默认驻留一个名为 ubusd 的守护进程，使用友好的 JSON 格式进行交互。<br>在命令行中输入 <code>ubus list</code> 就可以看到所有通过RPC服务器注册的命名空间：</p>
                                        <pre><code>dhcp
hostapd.wlan0
hostapd.wlan1
log
network
network.device
network.interface
network.interface.lan
network.interface.loopback
network.interface.wan
network.interface.wan6
network.wireless
service
session
system
uci
</code></pre>
                                        <p>加个参数变成 <code>ubus -v list</code>，就可以详细列出这些命名空间所提供的方法了。调用方法用 <code>call</code> 关键字，比如，查看系统 WiFi 状态就可以用：</p>
                                        <pre class=" language-bash"><code class="language-bash">ubus call network.wireless status <span class="token string">'{}'</span>
</code></pre>
                                        <p><em>（参数一定要带上，即使为空。格式为 JSON）</em></p>
                                        <p>除此以外，还有：</p>
                                        <ul>
                                            <li>获取系统信息（上线时间、内存用量、SWAP信息等）
                                                <pre class=" language-bash"><code class="language-bash">ubus call system info <span class="token string">'{}'</span>
</code></pre>
                                            </li>
                                            <li>获取设备信息（设备型号、固件版本等）
                                                <pre class=" language-bash"><code class="language-bash">ubus call system board <span class="token string">'{}'</span>
</code></pre>
                                            </li>
                                            <li>获取 WiFi 上已连接的客户端
                                                <pre class=" language-bash"><code class="language-bash">ubus call hostapd.wlan0 get_clients <span class="token string">'{}'</span>
</code></pre>
                                            </li>
                                            <li>获取路由物理设备信息（如 MAC 型号、工作状态等）
                                                <pre class=" language-bash"><code class="language-bash">ubus call network.device status <span class="token string">'{"name":"eth0"}'</span>
</code></pre> 等等。<br>除了命令行直接调用外，ubus 也可以使用 Lua 调用，由于没有 UCI 那劳什子匿名节点的问题，所以直接用
                                                <pre class=" language-lua"><code class="language-lua"><span class="token keyword">local</span> ubus <span class="token operator">=</span> require <span class="token string">"ubus"</span>
</code></pre> 引入，在调用前用
                                                <pre class=" language-lua"><code class="language-lua"><span class="token keyword">local</span> conn <span class="token operator">=</span> ubus<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 连接服务，在调用后用
                                                <pre class=" language-lua"><code class="language-lua">conn<span class="token punctuation">:</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 关闭就好。<br>比如我自己写的一段从 ubus 上拿 WiFi 信息的函数：
                                                <pre class=" language-lua"><code class="language-lua"><span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">getWirelessStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">local</span> conn <span class="token operator">=</span> ubus<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token keyword">not</span> conn <span class="token keyword">then</span>
      <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Failed to connect to ubusd"</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>
  <span class="token keyword">local</span> info <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">local</span> status <span class="token operator">=</span> conn<span class="token punctuation">:</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">"network.wireless"</span><span class="token punctuation">,</span> <span class="token string">"status"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> <span class="token function">pairs</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token keyword">do</span>
      info<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> v
  <span class="token keyword">end</span>
  conn<span class="token punctuation">:</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    
  <span class="token keyword">return</span> info
<span class="token keyword">end</span>
</code></pre>
                                            </li>
                                        </ul>
                                        <hr>
                                        <h2 id="参考内容"><a href="#参考内容" class="headerlink" title="参考内容"></a>参考内容</h2>
                                        <ol>
                                            <li><a href="https://openwrt.org/start?id=zh/docs/guide-user/base-system/uci" target="_blank" rel="noopener">OpenWRT官网 - UCI系统</a></li>
                                            <li><a href="https://openwrt.org/start?id=zh/docs/techref/uci" target="_blank" rel="noopener">OpenWRT官网 - UCI技术参考资料</a></li>
                                            <li><a href="https://htmlpreview.github.io/?https://raw.githubusercontent.com/openwrt/luci/master/documentation/api/modules/luci.model.uci.html" target="_blank" rel="noopener">LuaDoc - luci.model.uci (英)</a></li>
                                            <li><a href="https://openwrt.org/start?id=zh/docs/techref/ubus" target="_blank" rel="noopener">OpenWRT官网 - ubus</a></li>
                                        </ol>
                                    </div>
                                    <div>
                                        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
                                            <div></div>
                                            <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
                                                <span>打赏</span>
                                            </button>
                                            <div id="QR" style="display: none;">
                                                <div id="wechat" style="display: inline-block">
                                                    <img id="wechat_qr" src="/images/wechat.png" alt="某熊猫桑 微信支付">
                                                    <p>微信支付</p>
                                                </div>
                                                <div id="alipay" style="display: inline-block">
                                                    <img id="alipay_qr" src="/images/alipay.jpg" alt="某熊猫桑 支付宝">
                                                    <p>支付宝</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <ul class="post-copyright">
                                            <li class="post-copyright-author">
                                                <strong>本文作者： </strong>某熊猫桑</li>
                                            <li class="post-copyright-link">
                                                <strong>本文链接：</strong>
                                                <a href="https://marsgt.github.io/2019/03/05/OpenWRT路由器设置界面中的Lua填坑/" title="OpenWRT路由器设置界面中的Lua填坑">https://marsgt.github.io/2019/03/05/OpenWRT路由器设置界面中的Lua填坑/</a>
                                            </li>
                                            <li class="post-copyright-license">
                                                <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-ND</a> 许可协议。转载请注明出处！</li>
                                        </ul>
                                    </div>
                                    <footer class="post-footer">
                                        <div class="post-tags">
                                            <a href="/tags/随手记/" rel="tag"># 随手记</a>
                                            <a href="/tags/OpenWRT/" rel="tag"># OpenWRT</a>
                                        </div>
                                        <div class="post-nav">
                                            <div class="post-nav-next post-nav-item">
                                                <a href="/2019/01/24/Git提交信息样式指南/" rel="next" title="Git提交信息样式指南">
                                                    <i class="fa fa-chevron-left"></i> Git提交信息样式指南 </a>
                                            </div>
                                            <span class="post-nav-divider"></span>
                                            <div class="post-nav-prev post-nav-item">
                                                <a href="/2019/04/22/【转】使用React和HTML5表单验证API处理表单元素/" rel="prev" title="【转】使用React和HTML5表单验证API处理表单元素"> 【转】使用React和HTML5表单验证API处理表单元素 <i class="fa fa-chevron-right"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </footer>
                                </div>
                            </article>
                        </div>
                    </div>
                    <div id="gitalk-container">
                    </div>
                </div>
                <div class="sidebar-toggle">
                    <div class="sidebar-toggle-line-wrap">
                        <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
                        <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
                        <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
                    </div>
                </div>
                <aside id="sidebar" class="sidebar">
                    <div class="sidebar-inner">
                        <ul class="sidebar-nav motion-element">
                            <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录 </li>
                            <li class="sidebar-nav-overview" data-target="site-overview-wrap"> 站点概览 </li>
                        </ul>
                        <section class="site-overview-wrap sidebar-panel">
                            <div class="site-overview">
                                <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
                                    <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="某熊猫桑">
                                    <p class="site-author-name" itemprop="name">某熊猫桑</p>
                                    <p class="site-description motion-element" itemprop="description"></p>
                                </div>
                                <nav class="site-state motion-element">
                                    <div class="site-state-item site-state-posts">
                                        <a href="/archives">
                                            <span class="site-state-item-count">20</span>
                                            <span class="site-state-item-name">日志</span>
                                        </a>
                                    </div>
                                    <div class="site-state-item site-state-categories">
                                        <a href="/categories/index.html">
                                            <span class="site-state-item-count">11</span>
                                            <span class="site-state-item-name">分类</span>
                                        </a>
                                    </div>
                                    <div class="site-state-item site-state-tags">
                                        <a href="/tags/index.html">
                                            <span class="site-state-item-count">34</span>
                                            <span class="site-state-item-name">标签</span>
                                        </a>
                                    </div>
                                </nav>
                                <div class="feed-link motion-element">
                                    <a href="/atom.xml" rel="alternate">
                                        <i class="fa fa-rss"></i> RSS </a>
                                </div>
                                <div class="links-of-author motion-element">
                                    <span class="links-of-author-item">
                                        <a href="https://github.com/MarsGT" title="GitHub &rarr; https://github.com/MarsGT" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                                    </span>
                                    <span class="links-of-author-item">
                                        <a href="mailto:marsgt@qq.com" title="E-Mail &rarr; mailto:marsgt@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                                    </span>
                                    <span class="links-of-author-item">
                                        <a href="https://segmentfault.com/u/marsgt" title="SegmentFault &rarr; https://segmentfault.com/u/marsgt" rel="noopener" target="_blank"><i class="fa fa-fw fa-bolt"></i>SegmentFault</a>
                                    </span>
                                </div>
                                <div class="cc-license motion-element" itemprop="license">
                                    <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-nd.svg" alt="Creative Commons"></a>
                                </div>
                            </div>
                        </section>
                        <!--noindex-->
                        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
                            <div class="post-toc">
                                <div class="post-toc-content">
                                    <ol class="nav">
                                        <li class="nav-item nav-level-2"><a class="nav-link" href="#UCI"><span class="nav-number">1.</span> <span class="nav-text">UCI</span></a>
                                            <ol class="nav-child">
                                                <li class="nav-item nav-level-3"><a class="nav-link" href="#基础知识"><span class="nav-number">1.1.</span> <span class="nav-text">基础知识</span></a></li>
                                                <li class="nav-item nav-level-3"><a class="nav-link" href="#UCI-的调用"><span class="nav-number">1.2.</span> <span class="nav-text">UCI 的调用</span></a></li>
                                            </ol>
                                        </li>
                                        <li class="nav-item nav-level-2"><a class="nav-link" href="#ubus"><span class="nav-number">2.</span> <span class="nav-text">ubus</span></a>
                                            <ol class="nav-child">
                                                <li class="nav-item nav-level-3"><a class="nav-link" href="#ubus-的调用"><span class="nav-number">2.1.</span> <span class="nav-text">ubus 的调用</span></a></li>
                                            </ol>
                                        </li>
                                        <li class="nav-item nav-level-2"><a class="nav-link" href="#参考内容"><span class="nav-number">3.</span> <span class="nav-text">参考内容</span></a></li>
                                    </ol>
                                </div>
                            </div>
                        </section>
                        <!--/noindex-->
                    </div>
                </aside>
            </div>
        </main>
        <footer id="footer" class="footer">
            <div class="footer-inner">
                <div class="copyright">&copy; 2016 – <span itemprop="copyrightYear">2019</span>
                    <span class="with-love" id="animate">
                        <i class="fa fa-user"></i>
                    </span>
                    <span class="author" itemprop="copyrightHolder">某熊猫桑</span>
                </div>
                <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动</div>
                <span class="post-meta-divider">|</span>
                <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a></div>
                <div class="busuanzi-count">
                    <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
                    <span class="site-uv" title="总访客量">
                        <i class="fa fa-user"></i>
                        <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
                    </span>
                    <span class="site-pv" title="总访问量">
                        <i class="fa fa-eye"></i>
                        <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
                    </span>
                </div>
            </div>
        </footer>
        <div class="back-to-top">
            <i class="fa fa-arrow-up"></i>
        </div>
    </div>
    <script type="text/javascript">
        if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
            window.Promise = null;
        }
    </script>
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
    <script type="text/javascript" src="/js/src/utils.js?v=6.6.0"></script>
    <script type="text/javascript" src="/js/src/motion.js?v=6.6.0"></script>
    <script type="text/javascript" src="/js/src/scrollspy.js?v=6.6.0"></script>
    <script type="text/javascript" src="/js/src/post-details.js?v=6.6.0"></script>
    <script type="text/javascript" src="/js/src/bootstrap.js?v=6.6.0"></script>
    <script type="text/javascript" src="//cdn.bootcss.com/gitalk/1.4.1/gitalk.min.js"></script>
    <link rel="stylesheet" href="//cdn.bootcss.com/gitalk/1.4.1/gitalk.min.css">
    <script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.min.js"></script>
    <script type="text/javascript">
        var gitalk = new Gitalk({
            clientID: 'f9476f25efdc8e2acc82',
            clientSecret: '7f41fcdff63ca48d96b9feb5b00186ece23e8a7f',
            repo: 'marsgt.github.io',
            owner: 'MarsGT',
            admin: ['MarsGT'],
            id: md5(location.pathname),
            distractionFreeMode: 'true',
            pagerDirection: 'first'
        })
        gitalk.render('gitalk-container')
    </script>
    <script>
        (function() {
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            } else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>
</body>

</html>