<!DOCTYPE html>
<html class="theme-next mist use-motion" lang="zh-CN">

<head>
    <meta name="generator" content="Hexo 3.8.0">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="theme-color" content="#222">
    <link rel="stylesheet" media="all" href="/lib/Han/dist/han.min.css?v=3.3">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">
    <link href="/css/main.css?v=6.6.0" rel="stylesheet" type="text/css">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/panda-32x32.png?v=6.6.0">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/panda-16x16.png?v=6.6.0">
    <script type="text/javascript" id="hexo.configurations">
        var NexT = window.NexT || {};
        var CONFIG = {
            root: '/',
            scheme: 'Mist',
            version: '6.6.0',
            sidebar: {
                "position": "left",
                "display": "post",
                "offset": 12,
                "b2t": false,
                "scrollpercent": false,
                "onmobile": false
            },
            fancybox: false,
            fastclick: false,
            lazyload: false,
            tabs: true,
            motion: {
                "enable": true,
                "async": false,
                "transition": {
                    "post_block": "fadeIn",
                    "post_header": "slideDownIn",
                    "post_body": "slideDownIn",
                    "coll_header": "slideLeftIn",
                    "sidebar": "slideUpIn"
                }
            },
            algolia: {
                applicationID: '',
                apiKey: '',
                indexName: '',
                hits: {
                    "per_page": 10
                },
                labels: {
                    "input_placeholder": "Search for Posts",
                    "hits_empty": "We didn't find any results for the search: ${query}",
                    "hits_stats": "${hits} results found in ${time} ms"
                }
            }
        };
    </script>
    <meta name="description" content="前段时间参与了一个H5项目，里边有个需求是用户上传图片。当时的方案是前端先调用微信的JSSDK选择图片并上传，然后再从后端下载到服务器上。然而用的时候发现客户端给的图片有大有小，但是由于用了微信的接口，图片在下载之前是没法控制的。后来在想能不能调用HTML5原生的文件上传接口，另外还可以配合阿里云的OSS对图片做进一步处理，所以就有了这篇文章。">
    <meta name="keywords" content="PHP,JavaScript,阿里云,OSS">
    <meta property="og:type" content="article">
    <meta property="og:title" content="前端图片直传OSS试验">
    <meta property="og:url" content="https://marsgt.github.io/2016/08/31/前端图片直传OSS试验/index.html">
    <meta property="og:site_name" content="lx熊猫桑的自留地">
    <meta property="og:description" content="前段时间参与了一个H5项目，里边有个需求是用户上传图片。当时的方案是前端先调用微信的JSSDK选择图片并上传，然后再从后端下载到服务器上。然而用的时候发现客户端给的图片有大有小，但是由于用了微信的接口，图片在下载之前是没法控制的。后来在想能不能调用HTML5原生的文件上传接口，另外还可以配合阿里云的OSS对图片做进一步处理，所以就有了这篇文章。">
    <meta property="og:locale" content="zh-CN">
    <meta property="og:updated_time" content="2018-12-30T01:47:10.865Z">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="前端图片直传OSS试验">
    <meta name="twitter:description" content="前段时间参与了一个H5项目，里边有个需求是用户上传图片。当时的方案是前端先调用微信的JSSDK选择图片并上传，然后再从后端下载到服务器上。然而用的时候发现客户端给的图片有大有小，但是由于用了微信的接口，图片在下载之前是没法控制的。后来在想能不能调用HTML5原生的文件上传接口，另外还可以配合阿里云的OSS对图片做进一步处理，所以就有了这篇文章。">
    <link rel="canonical" href="https://marsgt.github.io/2016/08/31/前端图片直传OSS试验/">
    <script type="text/javascript" id="page.configurations">
        CONFIG.page = {
            sidebar: "",
        };
    </script>
    <title>前端图片直传OSS试验 | lx熊猫桑的自留地</title>
    <noscript>
        <style> .use-motion .motion-element,
        .use-motion .brand,
        .use-motion .menu-item,
        .sidebar-inner,
        .use-motion .post-block,
        .use-motion .pagination,
        .use-motion .comments,
        .use-motion .post-header,
        .use-motion .post-body,
        .use-motion .collection-title {
            opacity: initial;
        }

        .use-motion .logo,
        .use-motion .site-title,
        .use-motion .site-subtitle {
            opacity: initial;
            top: initial;
        }

        .use-motion .logo-line-before i {
            left: initial;
        }

        .use-motion .logo-line-after i {
            right: initial;
        }
    </style>
    </noscript>
</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">
    <div class="container sidebar-position-left page-post-detail">
        <div class="headband"></div>
        <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
            <div class="header-inner">
                <div class="site-brand-wrapper">
                    <div class="site-meta ">
                        <div class="custom-logo-site-title">
                            <a href="/" class="brand" rel="start">
                                <span class="logo-line-before"><i></i></span>
                                <span class="site-title">lx熊猫桑的自留地</span>
                                <span class="logo-line-after"><i></i></span>
                            </a>
                        </div>
                    </div>
                    <div class="site-nav-toggle">
                        <button aria-label="切换导航栏">
                            <span class="btn-bar"></span>
                            <span class="btn-bar"></span>
                            <span class="btn-bar"></span>
                        </button>
                    </div>
                </div>
                <nav class="site-nav">
                    <ul id="menu" class="menu">
                        <li class="menu-item menu-item-home">
                            <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>
                        </li>
                        <li class="menu-item menu-item-tags">
                            <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>
                        </li>
                        <li class="menu-item menu-item-categories">
                            <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </header>
        <main id="main" class="main">
            <div class="main-inner">
                <div class="content-wrap">
                    <div id="content" class="content">
                        <div id="posts" class="posts-expand">
                            <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
                                <div class="post-block">
                                    <link itemprop="mainEntityOfPage" href="https://marsgt.github.io/2016/08/31/前端图片直传OSS试验/">
                                    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
                                        <meta itemprop="name" content="lx熊猫桑">
                                        <meta itemprop="description" content="">
                                        <meta itemprop="image" content="/images/avatar.jpg">
                                    </span>
                                    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
                                        <meta itemprop="name" content="lx熊猫桑的自留地">
                                    </span>
                                    <header class="post-header">
                                        <h1 class="post-title" itemprop="name headline">前端图片直传OSS试验 </h1>
                                        <div class="post-meta">
                                            <span class="post-time">
                                                <span class="post-meta-item-icon">
                                                    <i class="fa fa-calendar-o"></i>
                                                </span>
                                                <span class="post-meta-item-text">发表于</span>
                                                <time title="创建时间：2016-08-31 15:38:27" itemprop="dateCreated datePublished" datetime="2016-08-31T15:38:27+08:00">2016-08-31</time>
                                            </span>
                                            <span class="post-category">
                                                <span class="post-meta-divider">|</span>
                                                <span class="post-meta-item-icon">
                                                    <i class="fa fa-folder-o"></i>
                                                </span>
                                                <span class="post-meta-item-text">分类于</span>
                                                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/经验技巧/" itemprop="url" rel="index"><span itemprop="name">经验技巧</span></a></span> ， <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/经验技巧/前端/" itemprop="url" rel="index"><span itemprop="name">前端</span></a></span>
                                            </span>
                                        </div>
                                    </header>
                                    <div class="post-body han-init-context" itemprop="articleBody">
                                        <p>前段时间参与了一个H5项目，里边有个需求是用户上传图片。当时的方案是前端先调用微信的JSSDK选择图片并上传，然后再从后端下载到服务器上。然而用的时候发现客户端给的图片有大有小，但是由于用了微信的接口，图片在下载之前是没法控制的。后来在想能不能调用HTML5原生的文件上传接口，另外还可以配合阿里云的OSS对图片做进一步处理，所以就有了这篇文章。 <a id="more"></a>
                                        </p>
                                        <h2 id="1-HTML5原生上传"><a href="#1-HTML5原生上传" class="headerlink" title="1. HTML5原生上传"></a>1. HTML5原生上传</h2>
                                        <p>其实之前也有想过用原生的，可手里的项目全是微信平台的H5，原生上传一直被告知有兼容性问题，所以这个方案一直是被搁置的；只是这次觉得用微信接口实在不爽才重新翻出来的，没想到意外发现手里的米4居然可以正常用。。好了闲话不说，上代码：</p>
                                        <figure class="highlight html">
                                            <table>
                                                <tr>
                                                    <td class="gutter">
                                                        <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                                                    </td>
                                                    <td class="code">
                                                        <pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"img_input"</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">accept</span>=<span class="string">"image/*"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"preview_box"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre>
                                                    </td>
                                                </tr>
                                            </table>
                                        </figure>
                                        <p>HTML部分主要就是那个input，至于下边那个div，主要是留着放图片预览用的。</p>
                                        <figure class="highlight html">
                                            <table>
                                                <tr>
                                                    <td class="gutter">
                                                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre>
                                                    </td>
                                                    <td class="code">
                                                        <pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://cdn.bootcss.com/jquery/2.2.4/jquery.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">    $(<span class="string">"#img_input"</span>).on(<span class="string">"change"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> file = e.target.files[<span class="number">0</span>]; <span class="comment">// 获取图片资源</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> fd = <span class="keyword">new</span> FormData(); <span class="comment">// 用formdata上传文件</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">        <span class="comment">// 只选择图片文件</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span> (!file.type.match(<span class="string">'image.*'</span>)) &#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">        fd.append(<span class="string">'file'</span>, file, file.name); <span class="comment">// 填入文件</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">        $.ajax(&#123;</span></span><br><span class="line"><span class="javascript">            url: <span class="string">'fileupload.php'</span>,</span></span><br><span class="line"><span class="undefined">            data: fd,</span></span><br><span class="line"><span class="javascript">            processData: <span class="literal">false</span>,</span></span><br><span class="line"><span class="javascript">            contentType: <span class="literal">false</span>,</span></span><br><span class="line"><span class="javascript">            type: <span class="string">'POST'</span>,</span></span><br><span class="line"><span class="javascript">            success: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                <span class="comment">// 成功后显示文件预览</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">var</span> reader = <span class="keyword">new</span> FileReader();</span></span><br><span class="line"><span class="javascript">                reader.readAsDataURL(file); <span class="comment">// 读取文件</span></span></span><br><span class="line"><span class="javascript">                <span class="comment">// 渲染文件</span></span></span><br><span class="line"><span class="javascript">                reader.onload = <span class="function"><span class="keyword">function</span>(<span class="params">ev</span>) </span>&#123;</span></span><br><span class="line"><span class="xml">                    var img = '<span class="tag">&lt;<span class="name">img</span> <span class="attr">class</span>=<span class="string">"preview"</span> <span class="attr">src</span>=<span class="string">"' + ev.target.result + '"</span> <span class="attr">alt</span>=<span class="string">"preview"</span>/&gt;</span>';</span></span><br><span class="line"><span class="javascript">                    $(<span class="string">"#preview_box"</span>).empty().append(img);</span></span><br><span class="line"><span class="undefined">                &#125;</span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="undefined">        &#125;);</span></span><br><span class="line"><span class="undefined">    &#125;);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre>
                                                    </td>
                                                </tr>
                                            </table>
                                        </figure>
                                        <p>文件填入FormData，然后POST上传，后端（用的PHP）简单写下接收就行。<br>(然后这里顺便想问下如果直接上传blob的话，PHP后端应该怎么写？有大神路过请不吝赐教~小弟这里先谢过了）</p>
                                        <figure class="highlight php">
                                            <table>
                                                <tr>
                                                    <td class="gutter">
                                                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                                                    </td>
                                                    <td class="code">
                                                        <pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($error == UPLOAD_ERR_OK) &#123;</span><br><span class="line">    $tmp_name = $_FILES[<span class="string">"file"</span>][<span class="string">"tmp_name"</span>];</span><br><span class="line">    $name = $_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>];</span><br><span class="line">    move_uploaded_file($tmp_name, <span class="string">"$name"</span>);</span><br><span class="line">&#125;</span><br></pre>
                                                    </td>
                                                </tr>
                                            </table>
                                        </figure>
                                        <p>然后处理下权限啥的，就能跑啦。</p>
                                        <h2 id="2-前端压缩（localResizeIMG）"><a href="#2-前端压缩（localResizeIMG）" class="headerlink" title="2. 前端压缩（localResizeIMG）"></a>2. 前端压缩（localResizeIMG）</h2>
                                        <p><a href="https://github.com/think2011/localResizeIMG" target="_blank" rel="noopener">localResizeIMG</a> 是个好插件，用法也很简单，把 GitHub 里的 dist 文件夹拖下来改个名（我改了个“localRZ”），然后直接引用 lrz.bundle.js 文件就行了：</p>
                                        <figure class="highlight html">
                                            <table>
                                                <tr>
                                                    <td class="gutter">
                                                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre>
                                                    </td>
                                                    <td class="code">
                                                        <pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://cdn.bootcss.com/jquery/2.2.4/jquery.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"localRZ/lrz.bundle.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">    $(<span class="string">"#img_input"</span>).on(<span class="string">"change"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> file = e.target.files[<span class="number">0</span>]; <span class="comment">//获取图片资源</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> filename = file.name;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">        <span class="comment">// 只选择图片文件</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span> (!file.type.match(<span class="string">'image.*'</span>)) &#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="javascript">        <span class="comment">// LocalResizeIMG处理：</span></span></span><br><span class="line"><span class="undefined">        lrz(file, &#123;width: 400&#125;)</span></span><br><span class="line"><span class="javascript">            .then(<span class="function"><span class="keyword">function</span> (<span class="params">rst</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                $.ajax(&#123;</span></span><br><span class="line"><span class="javascript">                    url: <span class="string">'fileupload.php'</span>,</span></span><br><span class="line"><span class="javascript">                    data: rst.formData, <span class="comment">// LocalResizeIMG 直接封装好的</span></span></span><br><span class="line"><span class="javascript">                    processData: <span class="literal">false</span>,</span></span><br><span class="line"><span class="javascript">                    contentType: <span class="literal">false</span>,</span></span><br><span class="line"><span class="javascript">                    type: <span class="string">'POST'</span></span></span><br><span class="line"><span class="javascript">                &#125;).done(<span class="function"><span class="keyword">function</span>(<span class="params">data, textStatus, jqXHR</span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">                    <span class="comment">// 图片预览</span></span></span><br><span class="line"><span class="javascript">                    <span class="keyword">var</span> img = <span class="keyword">new</span> Image();</span></span><br><span class="line"><span class="undefined">                    img.src = rst.base64;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">                    img.onload = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                        $(<span class="string">"#preview_box"</span>).empty().append(img);</span></span><br><span class="line"><span class="undefined">                    &#125;;</span></span><br><span class="line"><span class="undefined">                &#125;);</span></span><br><span class="line"><span class="javascript">                <span class="keyword">return</span> rst;</span></span><br><span class="line"><span class="undefined">            &#125;)</span></span><br><span class="line"><span class="javascript">            .catch(<span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                <span class="comment">// 万一出错了，这里可以捕捉到错误信息</span></span></span><br><span class="line"><span class="javascript">                <span class="comment">// 而且以上的then都不会执行</span></span></span><br><span class="line"><span class="javascript">                alert(<span class="string">'ERROR:'</span> + err);</span></span><br><span class="line"><span class="undefined">            &#125;)</span></span><br><span class="line"><span class="javascript">            .always(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                <span class="comment">// 不管是成功失败，这里都会执行</span></span></span><br><span class="line"><span class="undefined">            &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">    &#125;);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre>
                                                    </td>
                                                </tr>
                                            </table>
                                        </figure>
                                        <p>localResizeIMG 的 <a href="https://github.com/think2011/localResizeIMG/wiki" target="_blank" rel="noopener">文档</a> 写的挺清楚的，哪里不明白的话可以过去看看。</p>
                                        <h2 id="3-美化上传按钮"><a href="#3-美化上传按钮" class="headerlink" title="3. 美化上传按钮"></a>3. 美化上传按钮</h2>
                                        <p>原生的文件上传控件略丑，所以一般是要美化一下。<br>HTML：</p>
                                        <figure class="highlight html">
                                            <table>
                                                <tr>
                                                    <td class="gutter">
                                                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                                                    </td>
                                                    <td class="code">
                                                        <pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"filePicker"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"img_input"</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">accept</span>=<span class="string">"image/*"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"img_input"</span>&gt;</span>上传图片<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"preview_box"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre>
                                                    </td>
                                                </tr>
                                            </table>
                                        </figure>
                                        <p>放一个 lable 上去，然后隐藏掉原有的 input：</p>
                                        <figure class="highlight html">
                                            <table>
                                                <tr>
                                                    <td class="gutter">
                                                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre>
                                                    </td>
                                                    <td class="code">
                                                        <pre><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">    .filePicker &#123;</span></span><br><span class="line"><span class="undefined">        margin: 200px;</span></span><br><span class="line"><span class="undefined">        width: 200px;</span></span><br><span class="line"><span class="undefined">        height: 50px;</span></span><br><span class="line"><span class="undefined">        line-height: 50px;</span></span><br><span class="line"><span class="undefined">        text-align: center;</span></span><br><span class="line"><span class="undefined">        color: #fff;</span></span><br><span class="line"><span class="undefined">        background: #00b7ee;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="undefined">    .filePicker label &#123;</span></span><br><span class="line"><span class="undefined">        display: block;</span></span><br><span class="line"><span class="undefined">        width: 100%;</span></span><br><span class="line"><span class="undefined">        height: 100%;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="undefined">    .filePicker input[type="file"] &#123;</span></span><br><span class="line"><span class="undefined">        display: none;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre>
                                                    </td>
                                                </tr>
                                            </table>
                                        </figure>
                                        <p>这样看起来就舒服多了。</p>
                                        <h2 id="4-对接OSS"><a href="#4-对接OSS" class="headerlink" title="4. 对接OSS"></a>4. 对接OSS</h2>
                                        <p>关于直传，阿里官方给了三种方案：</p>
                                        <ol>
                                            <li>客户端 JavaScript 签名后直传；</li>
                                            <li>客户端申请服务端签名，然后打包上传；</li>
                                            <li>客户端申请服务端签名，打包上传OSS后回调服务端。</li>
                                        </ol>
                                        <p>这里主要用的是第二种。</p>
                                        <p>根据官方给的案例代码，首先要搞个签名用的PHP：</p>
                                        <figure class="highlight php">
                                            <table>
                                                <tr>
                                                    <td class="gutter">
                                                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre>
                                                    </td>
                                                    <td class="code">
                                                        <pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">gmt_iso8601</span><span class="params">($time)</span> </span>&#123;</span><br><span class="line">    $dtStr = date(<span class="string">"c"</span>, $time);</span><br><span class="line">    $mydatetime = <span class="keyword">new</span> DateTime($dtStr);</span><br><span class="line">    $expiration = $mydatetime-&gt;format(DateTime::ISO8601);</span><br><span class="line">    $pos = strpos($expiration, <span class="string">'+'</span>);</span><br><span class="line">    $expiration = substr($expiration, <span class="number">0</span>, $pos);</span><br><span class="line">    <span class="keyword">return</span> $expiration.<span class="string">"Z"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//自行设置AccessKey和相应Bucket的外网域名</span></span><br><span class="line">$id= <span class="string">'xxxxxxxxxxx'</span>;</span><br><span class="line">$key= <span class="string">'yyyyyyyyyy'</span>;</span><br><span class="line">$host = <span class="string">'http://zzzzzzz.oss-cn-xxxxxxxxx.aliyuncs.com/'</span>;</span><br><span class="line"></span><br><span class="line">$now = time();</span><br><span class="line">$expire = <span class="number">10</span>; <span class="comment">//设置该policy超时时间是10s. 即这个policy过了这个有效时间，将不能访问</span></span><br><span class="line">$end = $now + $expire;</span><br><span class="line">$expiration = gmt_iso8601($end);</span><br><span class="line"></span><br><span class="line"><span class="comment">//文件大小范围.用户可以自己设置</span></span><br><span class="line">$condition = <span class="keyword">array</span>(<span class="number">0</span>=&gt;<span class="string">'content-length-range'</span>, <span class="number">1</span>=&gt;<span class="number">0</span>, <span class="number">2</span>=&gt;<span class="number">1048576000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//设置用户上传指定的前缀</span></span><br><span class="line">$dir = <span class="string">'test/'</span>;</span><br><span class="line"><span class="comment">//用户上传数据的位置匹配,这一步不是必须项,只是为了安全起见,防止用户通过policy上传到别人的目录</span></span><br><span class="line">$start = <span class="keyword">array</span>(<span class="number">0</span>=&gt;<span class="string">'starts-with'</span>, <span class="number">1</span>=&gt;<span class="string">'$key'</span>, <span class="number">2</span>=&gt;$dir);</span><br><span class="line"></span><br><span class="line"><span class="comment">//设置bucket</span></span><br><span class="line">$bucket = <span class="keyword">array</span>(<span class="number">0</span>=&gt;<span class="string">'eq'</span>, <span class="number">1</span>=&gt;<span class="string">'$bucket'</span>, <span class="number">2</span>=&gt;<span class="string">'gmei'</span>);</span><br><span class="line"></span><br><span class="line">$conditions = <span class="keyword">array</span>(<span class="number">0</span>=&gt;$bucket, <span class="number">1</span>=&gt;$condition, <span class="number">2</span>=&gt;$start);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$arr = <span class="keyword">array</span>(<span class="string">'expiration'</span>=&gt;$expiration,<span class="string">'conditions'</span>=&gt;$conditions);</span><br><span class="line"><span class="comment">//echo json_encode($arr);</span></span><br><span class="line"><span class="comment">//return;</span></span><br><span class="line">$policy = json_encode($arr);</span><br><span class="line">$base64_policy = base64_encode($policy);</span><br><span class="line">$signature = base64_encode(hash_hmac(<span class="string">'sha1'</span>, $base64_policy, $key, <span class="keyword">true</span>));</span><br><span class="line"></span><br><span class="line">$response = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'accessid'</span> =&gt; $id,</span><br><span class="line">    <span class="string">'host'</span> =&gt; $host,</span><br><span class="line">    <span class="string">'policy'</span> =&gt; $base64_policy,</span><br><span class="line">    <span class="string">'signature'</span> =&gt; $signature,</span><br><span class="line">    <span class="string">'expire'</span> =&gt; $end,</span><br><span class="line">    <span class="string">'dir'</span> =&gt; $dir.<span class="string">'$&#123;filename&#125;'</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> json_encode($response);</span><br></pre>
                                                    </td>
                                                </tr>
                                            </table>
                                        </figure>
                                        <p>里边的东西填一下，然后保存在同目录下就行。然后改下HTML：</p>
                                        <figure class="highlight html">
                                            <table>
                                                <tr>
                                                    <td class="gutter">
                                                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre>
                                                    </td>
                                                    <td class="code">
                                                        <pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://cdn.bootcss.com/jquery/2.2.4/jquery.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"localRZ/lrz.bundle.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">    $(<span class="string">"#img_input"</span>).on(<span class="string">"change"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> file = e.target.files[<span class="number">0</span>]; <span class="comment">//获取图片资源</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> filename = file.name;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">        <span class="comment">// 只选择图片文件</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span> (!file.type.match(<span class="string">'image.*'</span>)) &#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="javascript">        <span class="comment">// LocalResizeIMG写法：</span></span></span><br><span class="line"><span class="javascript">        lrz(file, &#123;<span class="attr">width</span>: <span class="number">200</span>, <span class="attr">fieldName</span>: <span class="string">'osstest'</span>&#125;)</span></span><br><span class="line"><span class="javascript">            .then(<span class="function"><span class="keyword">function</span> (<span class="params">rst</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                <span class="comment">// OSS要求把上传文件放到最后一项，但是用LocalResizeIMG输出的FormData，就只能放在</span></span></span><br><span class="line"><span class="javascript">                <span class="comment">// 第一项，所以这里要自己new个出来</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">var</span> ossData = <span class="keyword">new</span> FormData();</span></span><br><span class="line"><span class="javascript">                <span class="comment">// 先请求授权，然后回调</span></span></span><br><span class="line"><span class="javascript">                $.getJSON(<span class="string">'ossget.php'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">json</span>) </span>&#123; <span class="comment">//签名用的PHP</span></span></span><br><span class="line"><span class="javascript">                    <span class="comment">// 添加签名信息</span></span></span><br><span class="line"><span class="javascript">                    ossData.append(<span class="string">'OSSAccessKeyId'</span>, json.accessid);</span></span><br><span class="line"><span class="javascript">                    ossData.append(<span class="string">'policy'</span>, json.policy);</span></span><br><span class="line"><span class="javascript">                    ossData.append(<span class="string">'Signature'</span>, json.signature);</span></span><br><span class="line"><span class="javascript">                    ossData.append(<span class="string">'key'</span>, json.dir);</span></span><br><span class="line"><span class="javascript">                    <span class="comment">// 添加文件</span></span></span><br><span class="line"><span class="javascript">                    ossData.append(<span class="string">'file'</span>, rst.file, filename);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">                    $.ajax(&#123;</span></span><br><span class="line"><span class="undefined">                        url: json.host,</span></span><br><span class="line"><span class="undefined">                        data: ossData,</span></span><br><span class="line"><span class="javascript">                        processData: <span class="literal">false</span>,</span></span><br><span class="line"><span class="javascript">                        contentType: <span class="literal">false</span>,</span></span><br><span class="line"><span class="javascript">                        type: <span class="string">'POST'</span></span></span><br><span class="line"><span class="javascript">                    &#125;).done(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">                        <span class="comment">// 成功后显示图片预览</span></span></span><br><span class="line"><span class="javascript">                        <span class="keyword">var</span> img = <span class="keyword">new</span> Image();</span></span><br><span class="line"><span class="undefined">                        img.src = rst.base64;</span></span><br><span class="line"><span class="javascript">                        img.onload = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                            $(<span class="string">".preview_box"</span>).empty().append(img);</span></span><br><span class="line"><span class="undefined">                        &#125;;</span></span><br><span class="line"><span class="undefined">                    &#125;);</span></span><br><span class="line"><span class="undefined">                &#125;);</span></span><br><span class="line"><span class="javascript">                <span class="keyword">return</span> rst;</span></span><br><span class="line"><span class="undefined">            &#125;)</span></span><br><span class="line"><span class="javascript">            .catch(<span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                <span class="comment">// 万一出错了，这里可以捕捉到错误信息</span></span></span><br><span class="line"><span class="javascript">                <span class="comment">// 而且以上的then都不会执行</span></span></span><br><span class="line"><span class="javascript">                alert(<span class="string">'ERROR:'</span> + err);</span></span><br><span class="line"><span class="undefined">            &#125;)</span></span><br><span class="line"><span class="javascript">            .always(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                <span class="comment">// 不管是成功失败，这里都会执行</span></span></span><br><span class="line"><span class="undefined">            &#125;);</span></span><br><span class="line"><span class="undefined">    &#125;);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre>
                                                    </td>
                                                </tr>
                                            </table>
                                        </figure>
                                        <h2 id="5-遗留问题"><a href="#5-遗留问题" class="headerlink" title="5. 遗留问题"></a>5. 遗留问题</h2>
                                        <ol>
                                            <li><del>OSS返回给客户端的XML没法正常解析</del></li>
                                            <li><del>返回的XML是报错内容，但是不影响文件的正常上传（文件上传返回的是默认的204）。报错内容是（大意）“[AccessDenied]：The bucket you visit is not belong to you.”，查了下文档说原因是“子用户没有Bucket管理的权限(如getBucketAcl CreateBucket、deleteBucket setBucketReferer、 getBucketReferer等)”，调了半天的 RAM（访问控制）也没弄好，不知道是什么原因~</del></li>
                                        </ol>
                                        <h2 id="6-2016-8-31-补遗："><a href="#6-2016-8-31-补遗：" class="headerlink" title="6. 2016/8/31 补遗："></a>6. 2016/8/31 补遗：</h2>
                                        <p>上次留下几个问题，已经解决了，所以过来填坑。</p>
                                        <p>其实这两个问题算是一个问题，在 PostObject 文档里，表单域里有个参数“success_action_status”，描述是“未指定success_action_redirect表单域时，该表单域指定了上传成功后返回给客户端的状态码。 接受值为200, 201, 204（默认）。 如果该域的值为200或者204，OSS返回一个空文档和相应的状态码。 如果该域的值设置为201，OSS返回一个XML文件和201状态码。 如果其值未设置或者设置成一个非法值，OSS返回一个空文档和204状态码。”所以，之前返回不正常的这个问题，只要强行指定返回201状态码，就可以正常收到返回的XML了（并且也没有先前报错的问题了）。</p>
                                        <p>上代码：</p>
                                        <figure class="highlight html">
                                            <table>
                                                <tr>
                                                    <td class="gutter">
                                                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre>
                                                    </td>
                                                    <td class="code">
                                                        <pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://cdn.bootcss.com/jquery/2.2.4/jquery.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"localRZ/lrz.bundle.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">    $(<span class="string">"#img_input"</span>).on(<span class="string">"change"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> file = e.target.files[<span class="number">0</span>]; <span class="comment">//获取图片资源</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> filename = file.name;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">        <span class="comment">// 只选择图片文件</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span> (!file.type.match(<span class="string">'image.*'</span>)) &#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="javascript">        <span class="comment">// LocalResizeIMG写法：</span></span></span><br><span class="line"><span class="javascript">        lrz(file, &#123;<span class="attr">width</span>: <span class="number">200</span>, <span class="attr">fieldName</span>: <span class="string">'osstest'</span>&#125;)</span></span><br><span class="line"><span class="javascript">            .then(<span class="function"><span class="keyword">function</span> (<span class="params">rst</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">var</span> ossData = <span class="keyword">new</span> FormData();</span></span><br><span class="line"><span class="javascript">                <span class="comment">// 先请求授权，然后回调</span></span></span><br><span class="line"><span class="javascript">                $.getJSON(<span class="string">'ossget.php'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">json</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                    <span class="comment">// 添加配置参数</span></span></span><br><span class="line"><span class="javascript">                    ossData.append(<span class="string">'OSSAccessKeyId'</span>, json.accessid);</span></span><br><span class="line"><span class="javascript">                    ossData.append(<span class="string">'policy'</span>, json.policy);</span></span><br><span class="line"><span class="javascript">                    ossData.append(<span class="string">'Signature'</span>, json.signature);</span></span><br><span class="line"><span class="javascript">                    ossData.append(<span class="string">'key'</span>, json.dir);</span></span><br><span class="line"><span class="javascript">                    ossData.append(<span class="string">'success_action_status'</span>, <span class="number">201</span>); <span class="comment">// 指定返回的状态码</span></span></span><br><span class="line"><span class="javascript">                    ossData.append(<span class="string">'file'</span>, rst.file, filename);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">                    $.ajax(&#123;</span></span><br><span class="line"><span class="undefined">                        url: json.host,</span></span><br><span class="line"><span class="undefined">                        data: ossData,</span></span><br><span class="line"><span class="javascript">                        dataType: <span class="string">'xml'</span>, <span class="comment">// 这里加个对返回内容的类型指定</span></span></span><br><span class="line"><span class="javascript">                        processData: <span class="literal">false</span>,</span></span><br><span class="line"><span class="javascript">                        contentType: <span class="literal">false</span>,</span></span><br><span class="line"><span class="javascript">                        type: <span class="string">'POST'</span></span></span><br><span class="line"><span class="javascript">                    &#125;).done(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">                        <span class="comment">// 返回的上传信息</span></span></span><br><span class="line"><span class="javascript">                        <span class="keyword">if</span> ($(data).find(<span class="string">'PostResponse'</span>)) &#123;</span></span><br><span class="line"><span class="javascript">                            <span class="keyword">var</span> res = $(data).find(<span class="string">'PostResponse'</span>);</span></span><br><span class="line"><span class="javascript">                            <span class="built_in">console</span>.info(<span class="string">'Bucket：'</span> + res.find(<span class="string">'Bucket'</span>).text() );</span></span><br><span class="line"><span class="javascript">                            <span class="built_in">console</span>.info(<span class="string">'Location：'</span> + res.find(<span class="string">'Location'</span>).text() );</span></span><br><span class="line"><span class="javascript">                            <span class="built_in">console</span>.info(<span class="string">'Key：'</span> + res.find(<span class="string">'Key'</span>).text() );</span></span><br><span class="line"><span class="javascript">                            <span class="built_in">console</span>.info(<span class="string">'ETag：'</span> + res.find(<span class="string">'ETag'</span>).text() );</span></span><br><span class="line"><span class="undefined">                        &#125;</span></span><br><span class="line"><span class="javascript">                        <span class="comment">// 图片预览</span></span></span><br><span class="line"><span class="javascript">                        <span class="keyword">var</span> img = <span class="keyword">new</span> Image();</span></span><br><span class="line"><span class="undefined">                        img.src = rst.base64;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">                        img.onload = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                            $(<span class="string">".preview_box"</span>).empty().append(img);</span></span><br><span class="line"><span class="undefined">                        &#125;;</span></span><br><span class="line"><span class="undefined">                    &#125;);</span></span><br><span class="line"><span class="undefined">                &#125;);</span></span><br><span class="line"><span class="javascript">                <span class="keyword">return</span> rst;</span></span><br><span class="line"><span class="undefined">            &#125;)</span></span><br><span class="line"><span class="javascript">            .catch(<span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                <span class="comment">// 万一出错了，这里可以捕捉到错误信息</span></span></span><br><span class="line"><span class="javascript">                <span class="comment">// 而且以上的then都不会执行</span></span></span><br><span class="line"><span class="javascript">                alert(<span class="string">'ERROR:'</span>+err);</span></span><br><span class="line"><span class="undefined">            &#125;)</span></span><br><span class="line"><span class="javascript">            .always(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                <span class="comment">// 不管是成功失败，这里都会执行</span></span></span><br><span class="line"><span class="undefined">            &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">    &#125;);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre>
                                                    </td>
                                                </tr>
                                            </table>
                                        </figure>
                                        <p>最后总结了下，HTTP 一定要学好啊！！（于是哭着滚去看书了……）</p>
                                        <hr>
                                        <p>【参考资料】</p>
                                        <ol>
                                            <li><a href="http://www.jquery123.com/jQuery.ajax/" target="_blank" rel="noopener">jQuery手册 - AJAX函数</a></li>
                                            <li><a href="http://www.zhangxinxu.com/wordpress/2013/10/understand-domstring-document-formdata-blob-file-arraybuffer/" target="_blank" rel="noopener">理解DOMString、Document、FormData、Blob、File、ArrayBuffer数据类型</a></li>
                                            <li><a href="https://help.aliyun.com/document_detail/31926.html" target="_blank" rel="noopener">对象存储OSS - Web端直传实践：采用服务端签名后直传</a></li>
                                            <li><a href="https://help.aliyun.com/document_detail/31988.html" target="_blank" rel="noopener">对象存储OSS - API手册 - Post Object</a></li>
                                            <li><a href="https://help.aliyun.com/knowledge_detail/42976.html" target="_blank" rel="noopener">对象存储OSS - API手册 - PostObject错误及排查</a></li>
                                            <li><a href="https://market.aliyun.com/products/53690006/cmgj000281.html" target="_blank" rel="noopener">对象存储OSS - OSS控制台客户端Windows版</a></li>
                                        </ol>
                                    </div>
                                    <div>
                                        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
                                            <div></div>
                                            <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
                                                <span>打赏</span>
                                            </button>
                                            <div id="QR" style="display: none;">
                                                <div id="wechat" style="display: inline-block">
                                                    <img id="wechat_qr" src="/images/wechat.png" alt="lx熊猫桑 微信支付">
                                                    <p>微信支付</p>
                                                </div>
                                                <div id="alipay" style="display: inline-block">
                                                    <img id="alipay_qr" src="/images/alipay.jpg" alt="lx熊猫桑 支付宝">
                                                    <p>支付宝</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <ul class="post-copyright">
                                            <li class="post-copyright-author">
                                                <strong>本文作者： </strong>lx熊猫桑</li>
                                            <li class="post-copyright-link">
                                                <strong>本文链接：</strong>
                                                <a href="https://marsgt.github.io/2016/08/31/前端图片直传OSS试验/" title="前端图片直传OSS试验">https://marsgt.github.io/2016/08/31/前端图片直传OSS试验/</a>
                                            </li>
                                            <li class="post-copyright-license">
                                                <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-ND</a> 许可协议。转载请注明出处！</li>
                                        </ul>
                                    </div>
                                    <footer class="post-footer">
                                        <div class="post-tags">
                                            <a href="/tags/PHP/" rel="tag"># PHP</a>
                                            <a href="/tags/JavaScript/" rel="tag"># JavaScript</a>
                                            <a href="/tags/阿里云/" rel="tag"># 阿里云</a>
                                            <a href="/tags/OSS/" rel="tag"># OSS</a>
                                        </div>
                                        <div class="post-nav">
                                            <div class="post-nav-next post-nav-item">
                                                <a href="/2016/01/10/brackets插件推荐/" rel="next" title="brackets插件推荐">
                                                    <i class="fa fa-chevron-left"></i> brackets插件推荐 </a>
                                            </div>
                                            <span class="post-nav-divider"></span>
                                            <div class="post-nav-prev post-nav-item">
                                                <a href="/2016/12/31/简单记录个a标签点不上的bug/" rel="prev" title="简单记录个a标签点不上的bug"> 简单记录个a标签点不上的bug <i class="fa fa-chevron-right"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </footer>
                                </div>
                            </article>
                        </div>
                    </div>
                    <div id="gitalk-container">
                    </div>
                </div>
                <div class="sidebar-toggle">
                    <div class="sidebar-toggle-line-wrap">
                        <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
                        <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
                        <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
                    </div>
                </div>
                <aside id="sidebar" class="sidebar">
                    <div class="sidebar-inner">
                        <ul class="sidebar-nav motion-element">
                            <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录 </li>
                            <li class="sidebar-nav-overview" data-target="site-overview-wrap"> 站点概览 </li>
                        </ul>
                        <section class="site-overview-wrap sidebar-panel">
                            <div class="site-overview">
                                <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
                                    <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="lx熊猫桑">
                                    <p class="site-author-name" itemprop="name">lx熊猫桑</p>
                                    <p class="site-description motion-element" itemprop="description"></p>
                                </div>
                                <nav class="site-state motion-element">
                                    <div class="site-state-item site-state-posts">
                                        <a href="/archives">
                                            <span class="site-state-item-count">13</span>
                                            <span class="site-state-item-name">日志</span>
                                        </a>
                                    </div>
                                    <div class="site-state-item site-state-categories">
                                        <a href="/categories/index.html">
                                            <span class="site-state-item-count">9</span>
                                            <span class="site-state-item-name">分类</span>
                                        </a>
                                    </div>
                                    <div class="site-state-item site-state-tags">
                                        <a href="/tags/index.html">
                                            <span class="site-state-item-count">26</span>
                                            <span class="site-state-item-name">标签</span>
                                        </a>
                                    </div>
                                </nav>
                                <div class="links-of-author motion-element">
                                    <span class="links-of-author-item">
                                        <a href="https://github.com/MarsGT" title="GitHub &rarr; https://github.com/MarsGT" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                                    </span>
                                    <span class="links-of-author-item">
                                        <a href="mailto:marsgt@qq.com" title="E-Mail &rarr; mailto:marsgt@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                                    </span>
                                    <span class="links-of-author-item">
                                        <a href="https://segmentfault.com/u/marsgt" title="SegmentFault &rarr; https://segmentfault.com/u/marsgt" rel="noopener" target="_blank"><i class="fa fa-fw fa-bolt"></i>SegmentFault</a>
                                    </span>
                                </div>
                                <div class="cc-license motion-element" itemprop="license">
                                    <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-nd.svg" alt="Creative Commons"></a>
                                </div>
                            </div>
                        </section>
                        <!--noindex-->
                        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
                            <div class="post-toc">
                                <div class="post-toc-content">
                                    <ol class="nav">
                                        <li class="nav-item nav-level-2"><a class="nav-link" href="#1-HTML5原生上传"><span class="nav-number">1.</span> <span class="nav-text">1. HTML5原生上传</span></a></li>
                                        <li class="nav-item nav-level-2"><a class="nav-link" href="#2-前端压缩（localResizeIMG）"><span class="nav-number">2.</span> <span class="nav-text">2. 前端压缩（localResizeIMG）</span></a></li>
                                        <li class="nav-item nav-level-2"><a class="nav-link" href="#3-美化上传按钮"><span class="nav-number">3.</span> <span class="nav-text">3. 美化上传按钮</span></a></li>
                                        <li class="nav-item nav-level-2"><a class="nav-link" href="#4-对接OSS"><span class="nav-number">4.</span> <span class="nav-text">4. 对接OSS</span></a></li>
                                        <li class="nav-item nav-level-2"><a class="nav-link" href="#5-遗留问题"><span class="nav-number">5.</span> <span class="nav-text">5. 遗留问题</span></a></li>
                                        <li class="nav-item nav-level-2"><a class="nav-link" href="#6-2016-8-31-补遗："><span class="nav-number">6.</span> <span class="nav-text">6. 2016/8/31 补遗：</span></a></li>
                                    </ol>
                                </div>
                            </div>
                        </section>
                        <!--/noindex-->
                    </div>
                </aside>
            </div>
        </main>
        <footer id="footer" class="footer">
            <div class="footer-inner">
                <div class="copyright">&copy; 2016 – <span itemprop="copyrightYear">2018</span>
                    <span class="with-love" id="animate">
                        <i class="fa fa-user"></i>
                    </span>
                    <span class="author" itemprop="copyrightHolder">lx熊猫桑</span>
                </div>
                <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动</div>
                <span class="post-meta-divider">|</span>
                <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a></div>
                <div class="busuanzi-count">
                    <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
                    <span class="site-uv" title="总访客量">
                        <i class="fa fa-user"></i>
                        <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
                    </span>
                    <span class="site-pv" title="总访问量">
                        <i class="fa fa-eye"></i>
                        <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
                    </span>
                </div>
            </div>
        </footer>
        <div class="back-to-top">
            <i class="fa fa-arrow-up"></i>
        </div>
    </div>
    <script type="text/javascript">
        if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
            window.Promise = null;
        }
    </script>
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
    <script type="text/javascript" src="/js/src/utils.js?v=6.6.0"></script>
    <script type="text/javascript" src="/js/src/motion.js?v=6.6.0"></script>
    <script type="text/javascript" src="/js/src/scrollspy.js?v=6.6.0"></script>
    <script type="text/javascript" src="/js/src/post-details.js?v=6.6.0"></script>
    <script type="text/javascript" src="/js/src/bootstrap.js?v=6.6.0"></script>
    <script type="text/javascript" src="//cdn.bootcss.com/gitalk/1.4.1/gitalk.min.js"></script>
    <link rel="stylesheet" href="//cdn.bootcss.com/gitalk/1.4.1/gitalk.min.css">
    <script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/1.1.0/js/md5.min.js"></script>
    <script type="text/javascript">
        var gitalk = new Gitalk({
            clientID: 'f9476f25efdc8e2acc82',
            clientSecret: '7f41fcdff63ca48d96b9feb5b00186ece23e8a7f',
            repo: 'marsgt.github.io',
            owner: 'MarsGT',
            admin: ['MarsGT'],
            id: md5(location.pathname),
            distractionFreeMode: 'true',
            pagerDirection: 'first'
        })
        gitalk.render('gitalk-container')
    </script>
</body>

</html>